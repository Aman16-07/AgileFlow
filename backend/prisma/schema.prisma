// ============================================================
// PRISMA SCHEMA — ProjectFlow
// Production-grade, fully relational, indexed
// SQLite-compatible (enums stored as strings)
// ============================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// NOTE: Enum values used as strings:
// Role: ADMIN | PROJECT_MANAGER | DEVELOPER
// SpaceVisibility: PRIVATE | TEAM
// SprintStatus: PLANNED | ACTIVE | COMPLETED
// IssueType: STORY | BUG | TASK | EPIC | SUBTASK
// Priority: CRITICAL | HIGH | MEDIUM | LOW | NONE
// ActivityAction: CREATED | UPDATED | COMMENTED | STATUS_CHANGED | ASSIGNED | PRIORITY_CHANGED | MOVED | ATTACHED | DELETED
// StarrableType: SPACE | BOARD | TASK
// RecentItemType: SPACE | BOARD | TASK

// ─── USER ─────────────────────────────────────────────────

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  passwordHash  String
  displayName   String
  avatarUrl     String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  memberships   SpaceMember[]
  assignedTasks Task[]         @relation("TaskAssignee")
  reportedTasks Task[]         @relation("TaskReporter")
  comments      Comment[]
  activities    Activity[]
  stars         Star[]
  recentItems   RecentItem[]
  attachments   Attachment[]
  refreshTokens RefreshToken[]

  @@index([email])
  @@map("users")
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

// ─── SPACE (Project) ──────────────────────────────────────

model Space {
  id          String          @id @default(uuid())
  name        String
  key         String          @unique // e.g., "SCRUM"
  slug        String          @unique // URL-friendly: "scrum-project"
  description String?
  iconUrl     String?
  visibility  String @default("TEAM")
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  // Relations
  members     SpaceMember[]
  boards      Board[]
  workflows   Workflow[]
  sprints     Sprint[]
  tasks       Task[]
  labels      Label[]
  stars       Star[]
  recentItems RecentItem[]

  @@index([key])
  @@index([slug])
  @@map("spaces")
}

model SpaceMember {
  id        String   @id @default(uuid())
  userId    String
  spaceId   String
  role      String   @default("DEVELOPER")
  joinedAt  DateTime @default(now())

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  space Space @relation(fields: [spaceId], references: [id], onDelete: Cascade)

  @@unique([userId, spaceId])
  @@index([userId])
  @@index([spaceId])
  @@map("space_members")
}

// ─── BOARD ────────────────────────────────────────────────

model Board {
  id        String   @id @default(uuid())
  name      String
  spaceId   String
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  space       Space        @relation(fields: [spaceId], references: [id], onDelete: Cascade)
  stars       Star[]
  recentItems RecentItem[]

  @@index([spaceId])
  @@map("boards")
}

// ─── WORKFLOW (Customizable Statuses) ─────────────────────

model Workflow {
  id        String   @id @default(uuid())
  spaceId   String
  name      String   // e.g., "Default Workflow"
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())

  space    Space           @relation(fields: [spaceId], references: [id], onDelete: Cascade)
  statuses WorkflowStatus[]

  @@index([spaceId])
  @@map("workflows")
}

model WorkflowStatus {
  id         String @id @default(uuid())
  workflowId String
  name       String // e.g., "To Do", "In Progress"
  slug       String // "to-do", "in-progress"
  color      String @default("#6B7280") // Tailwind gray-500
  position   Int    // Order in the board columns
  category   String @default("TODO") // TODO | IN_PROGRESS | DONE — for aggregation

  workflow Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  tasks    Task[]

  @@unique([workflowId, slug])
  @@index([workflowId, position])
  @@map("workflow_statuses")
}

// ─── SPRINT ───────────────────────────────────────────────

model Sprint {
  id        String       @id @default(uuid())
  spaceId   String
  name      String       // e.g., "Sprint 1"
  goal      String?
  status    String @default("PLANNED")
  startDate DateTime?
  endDate   DateTime?
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  space Space  @relation(fields: [spaceId], references: [id], onDelete: Cascade)
  tasks Task[]

  @@index([spaceId, status])
  @@map("sprints")
}

// ─── TASK (Issue) ─────────────────────────────────────────

model Task {
  id          String   @id @default(uuid())
  spaceId     String
  sprintId    String?
  statusId    String
  assigneeId  String?
  reporterId  String
  parentId    String?  // For subtasks / epics
  title       String
  description String?  // Rich text (stored as HTML/JSON)
  type        String    @default("TASK")
  priority    String    @default("MEDIUM")
  key         String    @unique // e.g., "SCRUM-3"
  number      Int       // Auto-increment per space
  position    Float     // Fractional indexing for ordering
  storyPoints Int?
  dueDate     DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  space       Space           @relation(fields: [spaceId], references: [id], onDelete: Cascade)
  sprint      Sprint?         @relation(fields: [sprintId], references: [id], onDelete: SetNull)
  status      WorkflowStatus  @relation(fields: [statusId], references: [id])
  assignee    User?           @relation("TaskAssignee", fields: [assigneeId], references: [id], onDelete: SetNull)
  reporter    User            @relation("TaskReporter", fields: [reporterId], references: [id])
  parent      Task?           @relation("TaskChildren", fields: [parentId], references: [id], onDelete: SetNull)
  children    Task[]          @relation("TaskChildren")
  comments    Comment[]
  activities  Activity[]
  attachments Attachment[]
  taskLabels  TaskLabel[]
  stars       Star[]
  recentItems RecentItem[]

  @@index([spaceId, sprintId])
  @@index([spaceId, statusId])
  @@index([assigneeId])
  @@index([reporterId])
  @@index([spaceId, number])
  @@index([key])
  @@index([spaceId, position])
  @@index([updatedAt])
  @@index([createdAt])
  @@map("tasks")
}

// ─── LABEL ────────────────────────────────────────────────

model Label {
  id      String @id @default(uuid())
  spaceId String
  name    String
  color   String @default("#3B82F6")

  space      Space       @relation(fields: [spaceId], references: [id], onDelete: Cascade)
  taskLabels TaskLabel[]

  @@unique([spaceId, name])
  @@map("labels")
}

model TaskLabel {
  id      String @id @default(uuid())
  taskId  String
  labelId String

  task  Task  @relation(fields: [taskId], references: [id], onDelete: Cascade)
  label Label @relation(fields: [labelId], references: [id], onDelete: Cascade)

  @@unique([taskId, labelId])
  @@map("task_labels")
}

// ─── COMMENT ──────────────────────────────────────────────

model Comment {
  id        String   @id @default(uuid())
  taskId    String
  authorId  String
  content   String   // Rich text
  parentId  String?  // Threaded comments
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  task    Task      @relation(fields: [taskId], references: [id], onDelete: Cascade)
  author  User      @relation(fields: [authorId], references: [id], onDelete: Cascade)
  parent  Comment?  @relation("CommentThread", fields: [parentId], references: [id], onDelete: SetNull)
  replies Comment[] @relation("CommentThread")

  @@index([taskId, createdAt])
  @@index([authorId])
  @@map("comments")
}

// ─── ACTIVITY LOG ─────────────────────────────────────────

model Activity {
  id        String         @id @default(uuid())
  taskId    String
  userId    String
  action    String
  field     String?        // Which field changed
  oldValue  String?
  newValue  String?
  metadata  String?        // Extra context (JSON string)
  createdAt DateTime       @default(now())

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([taskId, createdAt])
  @@index([userId, createdAt])
  @@map("activities")
}

// ─── ATTACHMENT ───────────────────────────────────────────

model Attachment {
  id         String   @id @default(uuid())
  taskId     String
  uploaderId String
  fileName   String
  fileUrl    String
  fileSize   Int
  mimeType   String
  createdAt  DateTime @default(now())

  task     Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  uploader User @relation(fields: [uploaderId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@map("attachments")
}

// ─── STAR (Bookmark) ──────────────────────────────────────

model Star {
  id         String       @id @default(uuid())
  userId     String
  entityType String
  spaceId    String?
  boardId    String?
  taskId     String?
  createdAt  DateTime     @default(now())

  user  User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  space Space? @relation(fields: [spaceId], references: [id], onDelete: Cascade)
  board Board? @relation(fields: [boardId], references: [id], onDelete: Cascade)
  task  Task?  @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@unique([userId, entityType, spaceId])
  @@unique([userId, entityType, boardId])
  @@unique([userId, entityType, taskId])
  @@index([userId, entityType])
  @@map("stars")
}

// ─── RECENT ITEMS ─────────────────────────────────────────

model RecentItem {
  id         String         @id @default(uuid())
  userId     String
  entityType String
  spaceId    String?
  boardId    String?
  taskId     String?
  accessedAt DateTime       @default(now())

  user  User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  space Space? @relation(fields: [spaceId], references: [id], onDelete: Cascade)
  board Board? @relation(fields: [boardId], references: [id], onDelete: Cascade)
  task  Task?  @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@unique([userId, entityType, spaceId])
  @@unique([userId, entityType, boardId])
  @@unique([userId, entityType, taskId])
  @@index([userId, accessedAt])
  @@map("recent_items")
}
